<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreezeWay - DashBoard</title>
    <link rel="stylesheet" href="TesteMenu.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,100,0,0" />
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            width: 100%;
        }
    </style>
</head>

<body onload="obterDadosGrafico()">
    <div class="navigation">
        <ul>
            <li class="list">
                <span class="title"
                    style="color: skyblue; font-size: x-large; text-align: center;padding-left: 70px;">FreezeWay</span>
            </li>
            <li>
                <span class="title"
                    style="color: white; font-size: large; text-align: center;padding-left: 70px;">Olá,&nbsp;&nbsp;<span
                        id="b_usuario">Usuário</span>!</span>
            </li><br>
            <li class="list">
                <a href="DashPesquisa.html">
                    <span class="icon"><ion-icon name="search-outline"></ion-icon></span>
                    <span class="title">Pesquisa</span>
                </a>
            </li>
            <li class="list active">
                <a href="#">
                    <span class="icon"><ion-icon name="thermometer-outline"></ion-icon></span>
                    <span class="title">Temperatura Atual</span>
                </a>
            </li>
            <li class="list">
                <a href="DashTemSemanal.html">
                    <span class="icon"> <ion-icon name="stats-chart-outline"></ion-icon></span>
                    <span class="title">Temperatura Semanal</span>
                </a>
            </li>
            <li class="list">
                <a href="DashTempAnual.html">
                    <span class="icon"><ion-icon name="bar-chart-outline"></ion-icon></span>
                    <span class="title">Temperatura Mensal</span>
                </a>
            </li>
            <li class="list">
                <a href="DashCadastroCaminhao.html">
                    <span class="icon"><ion-icon name="duplicate-outline"></ion-icon></span>
                    <span class="title">Cadastrar Caminhão</span>
                </a>
            </li>
            <li class="list">
                <a>
                    <span class="icon"><ion-icon name="log-out-outline"></ion-icon></span>
                    <span class="title">Sair</span>
                </a>
            </li>
        </ul>
    </div>

    <div class="body">
        <h1>Captura da Temperatura Atual</h1>
        <div class="canva" style="width: 60%;height: 60%;">
            <canvas id="myChartCanvas" class="canvas-container" style="width: 100%;height: 100%;"></canvas>
        </div>
        <div class="area-parametros-alerta" style="display: flex;justify-content: end;align-items: end;">
            <p class="titulo-legenda">
                De olho na Temperatura
            </p>
            <div class="parametros-alerta">
                <div class="item-regua perigo-frio">
                    <p>Congelada</p>
                    <p>&lt;= -25°C</p>
                </div>
                <div class="item-regua alerta-frio">
                    <p>Boa</p>
                    <p>&lt;= -20°C</p>
                </div>
                <div class="item-regua ideal">
                    <p>Ideal</p>
                    <p>-15°C</p>
                </div>
                <div class="item-regua alerta-quente">
                    <p>Atenção</p>
                    <p>&gt;= -12°C</p>
                </div>
                <div class="item-regua alerta-perigo">
                    <p>Perigo</p>
                    <p>&gt;= -8°C</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Adicione logs para depuração
        console.log('Script carregado');

        window.onload(obterDadosGrafico)

        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
        let chartInstance = null;
        let proximaAtualizacao;
        //         function obterDadosGrafico() {
        //     const idUsuario = Number(sessionStorage.ID_USUARIO);

        //     if (isNaN(idUsuario)) {
        //         console.error('ID_USUARIO não está definido ou não é um número válido');
        //         return;
        //     }

        //     fetch(`/medidas/ultimas/${idUsuario}`, { cache: 'no-store' })
        //         .then(function (response) {
        //             if (response.ok) {
        //                 response.json().then(function (resposta) {
        //                     console.log('Dados recebidos da API:', resposta);
        //                     plotarGrafico(resposta);
        //                 });
        //             } else {
        //                 console.error('Nenhum dado encontrado ou erro na API');
        //             }
        //         })
        //         .catch(function (error) {
        //             console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        //         });
        // }

        function obterDadosGrafico() {
            const Id_usuario = Number(sessionStorage.ID_USUARIO);
            fetch(`/medidas/ultimas/${Id_usuario}`, { cache: 'no-store' })
                .then(function (response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Nenhum dado encontrado ou erro na API');
                    }
                })
                .then(function (resposta) {
                    console.log(resposta);
                    plotarGrafico(resposta);
                })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados para o gráfico: ${error.message}`);
                });
        }




        function plotarGrafico(resposta) {
            const ctx = document.getElementById('myChartCanvas').getContext('2d');

            if (resposta.length === 0) {
                console.error('Resposta da API vazia');
                return;
            }

            const temperaturas = resposta.map(item => parseFloat(item.temperatura)); // Garantir que seja número
            const labels = resposta.map(item => moment(item.momento_grafico, 'HH:mm:ss').format('HH:mm:ss'));

            if (chartInstance !== null) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperatura',
                        data: temperaturas,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second',
                                parser: 'HH:mm:ss',
                                tooltipFormat: 'HH:mm:ss',
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Hora'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Temperatura (°C)'
                            }
                        }
                    }
                }
            });

            proximaAtualizacao = setTimeout(() => atualizarGrafico(Number(sessionStorage.ID_USUARIO), chartInstance), 2000);
        }


        function atualizarGrafico(idUsuario, myChart) {
            fetch(`/medidas/ultima/${idUsuario}`, { cache: 'no-store' })
                .then(function (response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Nenhum dado encontrado ou erro na API');
                    }
                })
                .then(function (novoRegistro) {
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    
                    if (novoRegistro.length > 0) {
                        const novoDado = novoRegistro[0];
                        const ultimoDado = myChart.data.labels[myChart.data.labels.length - 1];

                        if (novoDado.momento_grafico !== ultimoDado) {
                            myChart.data.labels.push(novoDado.momento_grafico);
                            myChart.data.datasets[0].data.push(parseFloat(novoDado.temperatura));

                            // Remover o primeiro elemento se o comprimento dos dados exceder 7
                            if (myChart.data.labels.length > 7) {
                                myChart.data.labels.shift();
                                myChart.data.datasets[0].data.shift();
                            }

                            myChart.update();
                        }
                    }
                    
                    // Agendamento da próxima atualização
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idUsuario, myChart), 2000);
                })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idUsuario, myChart), 2000);
                });
        }
            // function atualizarGrafico(Id_usuario, dadosMedidos, myChart) {

            //     const Id_usuario = Number(sessionStorage.ID_USUARIO);

            //     fetch(`/medidas/ultimas/${Id_usuario}`, { cache: 'no-store' })
            //         .then(response => {
            //             if (response.ok) {
            //                 return response.json();
            //             } else {
            //                 throw new Error('Nenhum dado encontrado ou erro na API');
            //             }
            //         })
            //         .then(novoRegistro => {
            //             console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            //             console.log(`Dados atuais do gráfico:`);
            //             console.log(dados);

            //             let avisoCaptura = document.getElementById(`avisoCaptura${Id_usuario}`);
            //             avisoCaptura.innerHTML = "";

            //             if (novoRegistro.length === 0) {
            //                 console.log("---------------------------------------------------------------");
            //                 console.log("Não há novos dados disponíveis para atualização.");
            //                 avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Não há novos dados disponíveis para atualização.";
            //                 console.log("---------------------------------------------------------------");
            //             } else {
            //                 const novoDado = novoRegistro[0];

            //                 // Verifica se o novo dado já está presente no gráfico
            //                 if (!dados.labels.includes(novoDado.momento_grafico)) {
            //                     dados.labels.push(novoDado.momento_grafico);
            //                     dados.datasets[0].data.push(parseFloat(novoDado.temperatura));

            //                     // Remover o primeiro elemento se o comprimento dos dados exceder 7
            //                     if (dados.labels.length > 7) {
            //                         dados.labels.shift();
            //                         dados.datasets[0].data.shift();
            //                     }

            //                     myChart.update();
            //                 } else {
            //                     console.log("---------------------------------------------------------------");
            //                     console.log("Como não há dados novos para captura, o gráfico não atualizará.");
            //                     avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará.";
            //                     console.log("Horário do novo dado capturado:");
            //                     console.log(novoDado.momento_grafico);
            //                     console.log("Horário do último dado capturado:");
            //                     console.log(dados.labels[dados.labels.length - 1]);
            //                     console.log("---------------------------------------------------------------");
            //                 }
            //             }
            //         })
            //         .catch(error => {
            //             console.error(`Erro na obtenção dos dados para o gráfico: ${error.message}`);
            //         })
            //         .finally(() => {
            //             // Agendamento da próxima atualização após 2 segundos
            //             setTimeout(() => atualizarGrafico(Id_usuario, dadosMedidos, myChart), 2000);
            //         });
            // }

        
        
    </script>
</body>

</html>